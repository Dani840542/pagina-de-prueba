
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Registro UTB - Estudiantes y Lectores</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 650px;
    margin: 30px auto;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 10px;
  }
  label, input, button {
    display: block;
    margin: 10px 0;
  }
  #mensaje {
    margin-top: 15px;
    font-weight: bold;
    color: green;
  }
  .atrasado {
    color: red;
    font-weight: bold;
  }
  #btnExport {
    margin-top: 20px;
  }
</style>
</head>
<body>
<h2>Registro de Estudiantes UTB</h2>
<div id="mensaje">Solicitando ubicación...</div>

<form id="registroForm" style="display:none;">
  <label for="paralelo">Código del Paralelo:</label>
  <input type="text" id="paralelo" required />

  <label for="cedula">Últimos 4 dígitos de la cédula:</label>
  <input type="text" id="cedula" maxlength="4" pattern="\d{4}" required />
  <div id="nombreEstudiante" style="font-weight: bold; margin-top: 5px;"></div>

  <button type="submit">Registrar</button>
</form>

<div id="registros" style="display:none;">
  <h3>Registros guardados</h3>
  <ul id="listaRegistros"></ul>
</div>

<button id="btnExport" style="display:none;">Exportar registros a CSV</button>

<script>
const rol = "estudiante";
const UTB_LAT = -1.234567;
const UTB_LON = -78.123456;
const RADIO_METROS = 100;

const mensaje = document.getElementById("mensaje");
const form = document.getElementById("registroForm");
const registrosDiv = document.getElementById("registros");
const lista = document.getElementById("listaRegistros");
const btnExport = document.getElementById("btnExport");

const estudiantes = {
  "6650": "Castro Velázquez Danixa"
};

document.getElementById("cedula").addEventListener("input", function() {
  const val = this.value;
  const nombreDiv = document.getElementById("nombreEstudiante");
  if (estudiantes[val]) {
    nombreDiv.textContent = "Nombre: " + estudiantes[val];
  } else {
    nombreDiv.textContent = "";
  }
});

function guardarRegistros(registros) {
  localStorage.setItem("registrosEstudiantes", JSON.stringify(registros));
}

function cargarRegistros() {
  const datos = localStorage.getItem("registrosEstudiantes");
  return datos ? JSON.parse(datos) : [];
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const rad = (x) => x * Math.PI / 180;
  const dLat = rad(lat2 - lat1);
  const dLon = rad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(rad(lat1)) * Math.cos(rad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function mostrarRegistros() {
  lista.innerHTML = "";
  const registros = cargarRegistros();
  if (registros.length === 0) {
    lista.innerHTML = "<li>No hay registros aún.</li>";
    return;
  }
  registros.forEach(reg => {
    const li = document.createElement("li");
    li.innerHTML = `Paralelo: ${reg.paralelo}, Cédula: ${reg.cedula}, Nombre: ${reg.nombre || "No registrado"}, Hora: ${reg.fecha}`;
    if (reg.atrasado) {
      li.classList.add("atrasado");
      li.innerHTML += " - <strong>ATRASADO</strong>";
    }
    lista.appendChild(li);
  });
}

function formatearFechaYHora() {
  const ahora = new Date();
  const horas = ahora.getHours().toString().padStart(2, '0');
  const minutos = ahora.getMinutes().toString().padStart(2, '0');
  const dia = ahora.getDate().toString().padStart(2, '0');
  const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
  const anio = ahora.getFullYear();
  return `${horas}:${minutos} - ${dia}/${mes}/${anio}`;
}

function exportarCSV() {
  const registros = cargarRegistros();
  if (registros.length === 0) {
    alert("No hay registros para exportar.");
    return;
  }

  const encabezados = ["Paralelo", "Cédula", "Nombre", "Fecha y Hora", "Atrasado"];
  const filas = registros.map(r => [
    r.paralelo,
    r.cedula,
    r.nombre || "",
    r.fecha,
    r.atrasado ? "Sí" : "No"
  ]);

  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += encabezados.join(",") + "\r\n";
  filas.forEach(fila => {
    csvContent += fila.join(",") + "\r\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "registros_utb.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

if (rol === "estudiante") {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const dist = calcularDistancia(lat, lon, UTB_LAT, UTB_LON);
        if (dist <= RADIO_METROS) {
          mensaje.textContent = "Ubicación verificada en UTB ✅";
          form.style.display = "block";
          registrosDiv.style.display = "block";
          mostrarRegistros();
        } else {
          mensaje.textContent = "No estás dentro del área permitida de la UTB. No puedes registrar.";
          form.style.display = "none";
          registrosDiv.style.display = "block";
          mostrarRegistros();
        }
      },
      () => {
        mensaje.textContent = "Permite acceso a ubicación para continuar.";
        form.style.display = "none";
      }
    );
  } else {
    mensaje.textContent = "Tu navegador no soporta geolocalización.";
    form.style.display = "none";
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const paralelo = document.getElementById("paralelo").value.trim();
    const cedula = document.getElementById("cedula").value.trim();
    const nombre = estudiantes[cedula] || "";

    const ahora = new Date();
    const hora = ahora.getHours();
    const minutos = ahora.getMinutes();
    const fecha = formatearFechaYHora();
    const atrasado = (hora > 12) || (hora === 12 && minutos >= 30);

    const registros = cargarRegistros();
    registros.push({ paralelo, cedula, nombre, fecha, atrasado });
    guardarRegistros(registros);

    alert("Registro guardado correctamente ✅");
    form.reset();
    document.getElementById("nombreEstudiante").textContent = "";
    mostrarRegistros();
  });

} else if (rol === "docente" || rol === "padre") {
  mensaje.textContent = "Acceso como lector - solo lectura y exportación";
  form.style.display = "none";
  registrosDiv.style.display = "block";
  btnExport.style.display = "inline-block";
  mostrarRegistros();
  btnExport.addEventListener("click", exportarCSV);

} else {
  mensaje.textContent = "Rol desconocido. Contacta al administrador.";
  form.style.display = "none";
}
</script>
</body>
</html>
